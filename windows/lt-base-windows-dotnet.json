{
  "variables": {
    "image_name": "{{env `IMAGE_NAME`}}",
    "image_family": "{{env `IMAGE_FAMILY`}}"
  },
  "builders": [
    {
      "type": "googlecompute",
      "account_file": "account.json",
      "project_id": "language-team",
      "source_image_family": "windows-2022-core",
      "image_name": "{{user `image_name`}}",
      "image_family": "{{user `image_family`}}",
      "disk_size": "128",
      "disk_type": "pd-ssd",
      "machine_type": "n1-standard-8",
      "communicator": "winrm",
      "winrm_username": "cicd",
      "winrm_insecure": true,
      "winrm_use_ssl": true,
      "metadata": {
        "windows-startup-script-cmd": "winrm quickconfig -quiet & net user /add cicd & net localgroup administrators cicd /add & winrm set winrm/config/service/auth @{Basic=\"true\"}"
      },
      "zone": "europe-west1-b",
      "state_timeout": "20m",
      "tags": ["packer"]
    }
  ],
  "provisioners": [
    {
      "type": "powershell",
      "scripts": [
        "{{template_dir}}/scripts/Initialize-VM.ps1"
      ]
    },
    {
      "type": "windows-restart",
      "restart_timeout": "10m"
    },
    {
      "type": "powershell",
      "scripts": [
        "{{template_dir}}/scripts/Install-DotNetSdk.ps1"
      ]
    },
    {
      "type": "windows-restart",
      "restart_timeout": "10m"
    },
    {
      "type": "powershell",
      "inline": [
        "choco install 7zip --version 21.7",
        "choco install nuget.commandline --version 6.1.0",
        "choco install sonarscanner-msbuild-net46 --version=5.5.3.43281",
        "choco install sonarscanner-msbuild-netcoreapp2.0 --version=5.5.3.43281",
        "choco install visualstudio2019buildtools --version 16.11.11.0 --package-parameters \"--allWorkloads --includeRecommended --includeOptional\"",
        "choco install visualstudio2019-workload-webbuildtools",
        "choco install visualstudio2019-workload-manageddesktopbuildtools",
        "choco install dotnetfx --version=4.8.0.20190930",
        "choco install netfx-4.8-devpack --version 4.8.0.20190930",
        "choco install openjdk11 --version 11.0.8.10",
        "choco install maven --version 3.6.2",
        "choco install git --version 2.29.2.2 --package-parameters \"/GitAndUnixToolsOnPath /NoShellIntegration\"",
        "choco install nodejs-lts --version 12.18.3"
      ]
    },
    {
      "type": "powershell",
      "scripts": [
        "{{template_dir}}/scripts/Install-VS2017.ps1",
        "{{template_dir}}/scripts/install_sonar_scanner.ps1",
        "{{template_dir}}/scripts/install_buildTools.ps1"
      ]
    },
    {
      "type": "windows-restart",
      "restart_timeout": "10m"
    },
    {
      "type": "powershell",
      "scripts": [
        "{{template_dir}}/scripts/Finalize-VM.ps1"
      ]
    }
  ]
}
